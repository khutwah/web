name: Review Deployment
on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed

concurrency:
  group: pr-${{ github.event.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write # To alllow commenting on PRs

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: superfly/fly-pr-review-apps@f7152c133b1fe7767b6e549ca09598655c1f8ca4 # v1.3.0
        id: deploy
        with:
          name: khutwah-review-${{ github.event.number }}
          config: deployments/review/fly.toml
          secrets: NEXT_PUBLIC_SUPABASE_URL=${{ secrets.REVIEW_SUPABASE_URL }} NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.REVIEW_SUPABASE_ANON_KEY }} DEFAULT_STUDENT_PASSWORD=${{ secrets.DEFAULT_STUDENT_PASSWORD }} DATABASE_URL=${{ secrets.REVIEW_DATABASE_URL }}
        env:
          DOCKER_BUILD: true
          NEXT_PUBLIC_APP_VERSION: pr-${{ github.event.number }}
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN_REVIEW }}
      - uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3.0.1
        with:
          message: Review app deployed at ${{ steps.deploy.outputs.url }}
          comment-tag: review
