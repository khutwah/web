name: Review Deployment
on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed

concurrency:
  group: pr-${{ github.event.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write # To alllow commenting on PRs

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_PREVIEWER }}
  SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD_PREVIEWER }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: supabase/setup-cli@fe52e8551e5e65c2c6a20121b1c0998d6c5e3e1f # v1.4.0
        with:
          version: latest
      - uses: JoeyRichter/fly-pr-review-apps@de8b3a752a672c987de9b1d4277995de2795a6bf # main, with build-arg.
        id: deploy
        with:
          name: khutwah-review-${{ github.event.number }}
          config: deployments/review/fly.toml
          secrets: NEXT_PUBLIC_SUPABASE_URL=${{ secrets.REVIEW_SUPABASE_URL }} NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.REVIEW_SUPABASE_ANON_KEY }} DEFAULT_STUDENT_PASSWORD=${{ secrets.DEFAULT_STUDENT_PASSWORD }} DATABASE_URL=${{ secrets.REVIEW_DATABASE_URL }}
          launch_options: --build-arg NEXT_PUBLIC_APP_VERSION=pr-${{ github.event.number }}
          build_args: |
            NEXT_PUBLIC_APP_VERSION=pr-${{ github.event.number }}
        env:
          DOCKER_BUILD: true
          NEXT_PUBLIC_APP_VERSION: pr-${{ github.event.number }}
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN_REVIEW }}
      - uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3.0.1
        with:
          message: |
            ✨ مَا شَاءَ ٱللَّٰهُ 🍃 your changes are deployed on ${{ steps.deploy.outputs.url }}. اَلْحَمْدُ لِلَّهِ ✨
          comment-tag: review
