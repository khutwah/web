name: Review Deployment
on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed

concurrency:
  group: pr-${{ github.event.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write # To alllow commenting on PRs

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_PREVIEWER }}
  SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD_PREVIEWER }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: supabase/setup-cli@fe52e8551e5e65c2c6a20121b1c0998d6c5e3e1f # v1.4.0
        with:
          version: latest
      - run: supabase link --project-ref xogqlhevomyaklpozrre # previewer project
      - run: supabase db push
      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: 22.x
      - run: npm ci
      - run: npm run seed
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.REVIEW_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.REVIEW_SUPABASE_ANON_KEY }}
          DATABASE_URL: ${{ secrets.REVIEW_DATABASE_URL }}
      - uses: superfly/fly-pr-review-apps@f7152c133b1fe7767b6e549ca09598655c1f8ca4 # v1.3.0
        id: deploy
        with:
          name: khutwah-review-${{ github.event.number }}
          config: deployments/review/fly.toml
          secrets: NEXT_PUBLIC_SUPABASE_URL=${{ secrets.REVIEW_SUPABASE_URL }} NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.REVIEW_SUPABASE_ANON_KEY }} DEFAULT_STUDENT_PASSWORD=${{ secrets.DEFAULT_STUDENT_PASSWORD }} DATABASE_URL=${{ secrets.REVIEW_DATABASE_URL }}
        env:
          DOCKER_BUILD: true
          NEXT_PUBLIC_APP_VERSION: pr-${{ github.event.number }}
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN_REVIEW }}
      - uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3.0.1
        with:
          message: |
            ‚ú® ŸÖŸéÿß ÿ¥Ÿéÿßÿ°Ÿé Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸè üçÉ your changes are deployed on ${{ steps.deploy.outputs.url }}. ÿßŸéŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸáŸê ‚ú®
          comment-tag: review
